/*
 * Map.cpp
 *
 *  Created on: Jun 23, 2015
 *      Author: Ori Damari & Or Shainberg
 */

#include "Map.h"
#include "Utils.h"
#include "lodepng.h"

Map::Map(char* mapPath) {
	// TODO Auto-generated constructor stub
	_mapPath = mapPath;
}

Map::~Map() {
	// TODO Auto-generated destructor stub
}

void Map::loadPng(){

	std::vector<unsigned char> image; //the raw pixels
	unsigned width, height;

	//decode
	unsigned error = lodepng::decode(image, width, height, _mapPath);

	//if there's an error, display it
	if (error)
		std::cout << "decoder error " << error << ": "
				<< lodepng_error_text(error) << std::endl;
	else {
	//the pixels are now in the vector "image", 4 bytes per pixel, ordered RGBARGBA..., use it as texture, draw it, ...

	_originalMap = new Matrix(height, width);

	for (int y = 0; y < height; y++)
			for (int x = 0; x < width; x++) {
				if (image[y * width * 4 + x * 4 + 0]
						|| image[y * width * 4 + x * 4 + 1]
						|| image[y * width * 4 + x * 4 + 2])
					_originalMap->set(y,x, Utils::FREE);
				else
					_originalMap->set(y,x, Utils::OCCUPIED);
			}
	}
}

void Map::blowMap() {
	// Blow map obsticles by robot radius
	int epsilon = 5;
	int robotRadius = ceil(
			(sqrt(pow(30 / 2, 2) + pow(30 / 2, 2))
					+ epsilon) / 2.5);

	for (int i = 0; i < height; i++) {
		for (int j = 0; j < width; j++) {
			if (_originalMap->get(i,j) == 1) {
				for (unsigned int k = i - robotRadius; k <= i + robotRadius;
						k++) {
					for (unsigned int l = j - robotRadius; l <= j + robotRadius;
							l++) {
						if (k > 0 && l > 0 && k < height && l < width
								&& _originalMap->get(k,l) == 0) {
							_originalMap->set(k,l,Utils::NOT);
						}
					}
				}
			}
		}
	}

	for (int i = 0; i < height; i++) {
		for (int j = 0; j < width; j++) {
			if (_originalMap->get(i,j) == Utils::NOT) {
				_originalMap->set(i,j,Utils::OCCUPIED);
			}
		}
	}
}

